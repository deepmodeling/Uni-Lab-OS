# 2026-01-13 物料搜寻确认弹窗自动处理功能

## 概述

本次更新为设备初始化流程添加了**物料搜寻确认弹窗自动检测与处理功能**。在设备初始化过程中，PLC 会弹出物料搜寻确认对话框，现在系统可以根据用户参数自动点击"是"或"否"按钮，无需手动干预。

## 背景问题

### 原有流程
1. 调用 `func_pack_device_init_auto_start_combined()` 初始化设备
2. PLC 在初始化过程中弹出物料搜寻确认对话框
3. **需要人工手动点击**"是"或"否"按钮
4. PLC 继续完成初始化并启动

### 存在的问题
- 需要人工干预，无法实现全自动化
- 影响批量生产效率
- 容易遗忘点击导致流程卡住

## 解决方案

### 新增 Modbus 地址配置

在 `coin_cell_assembly_b.csv` 第 69-71 行添加三个 coil：

| Name | DeviceType | Address | 说明 |
|------|-----------|---------|------|
| COIL_MATERIAL_SEARCH_DIALOG_APPEAR | coil | 6470 | 物料搜寻确认弹窗画面是否出现 |
| COIL_MATERIAL_SEARCH_CONFIRM_YES | coil | 6480 | 初始化物料搜寻确认按钮"是" |
| COIL_MATERIAL_SEARCH_CONFIRM_NO | coil | 6490 | 初始化物料搜寻确认按钮"否" |

**Modbus 地址转换：**
- CSV 6470 → Modbus 5176 (弹窗出现)
- CSV 6480 → Modbus 5184 (按钮"是")
- CSV 6490 → Modbus 5192 (按钮"否")

## 代码修改详情

### 1. coin_cell_assembly.py

#### 1.1 新增辅助方法 `_handle_material_search_dialog()`

**位置：** 第 799-901 行

**功能：**
- 监测物料搜寻确认弹窗是否出现（Coil 5176）
- 根据 `enable_search` 参数自动点击对应按钮
- 使用**脉冲模式**模拟真实按钮操作：`True` → 保持 0.5 秒 → `False`

**参数：**
- `enable_search: bool` - True=点击"是"(启用物料搜寻), False=点击"否"(不启用)
- `timeout: int = 30` - 等待弹窗出现的最大时间（秒）

**逻辑流程：**
```python
1. 监测 COIL_MATERIAL_SEARCH_DIALOG_APPEAR (每 0.5 秒检查一次)
2. 检测到弹窗出现 (Coil = True)
3. 选择按钮：
   - enable_search=True  → COIL_MATERIAL_SEARCH_CONFIRM_YES
   - enable_search=False → COIL_MATERIAL_SEARCH_CONFIRM_NO
4. 执行脉冲操作：
   - 写入 True (按下按钮)
   - 等待 0.5 秒
   - 写入 False (释放按钮)
   - 验证状态
```

#### 1.2 修改 `func_pack_device_init_auto_start_combined()`

**位置：** 第 904-1115 行

**主要改动：**

1. **添加新参数**
   ```python
   def func_pack_device_init_auto_start_combined(
       self, 
       material_search_enable: bool = False  # 新增参数
   ) -> bool:
   ```

2. **内联初始化逻辑并集成弹窗检测**
   - 不再调用 `self.func_pack_device_init()`
   - 将初始化逻辑直接实现在函数内
   - **在等待初始化完成的循环中实时检测弹窗**
   - 避免死锁：PLC 等待弹窗确认 ↔ 代码等待初始化完成

3. **关键代码片段**
   ```python
   # 等待初始化完成，同时检测物料搜寻弹窗
   while (self._sys_init_status()) == False:
       # 检查超时
       if time.time() - start_wait > max_wait_time:
           raise RuntimeError(f"初始化超时")
       
       # 如果还没处理弹窗，检测弹窗是否出现
       if not dialog_handled:
           dialog_state = self.client.use_node('COIL_MATERIAL_SEARCH_DIALOG_APPEAR').read(1)
           if dialog_actual:  # 弹窗出现
               # 执行脉冲按钮点击
               button_node.write(True)   # 按下
               time.sleep(0.5)            # 保持
               button_node.write(False)   # 释放
               dialog_handled = True
       
       time.sleep(1)
   ```

4. **步骤调整**
   - 步骤 0: 前置条件检查
   - 步骤 1: 设备初始化（**包含弹窗检测**）
   - 步骤 1.5: 已在步骤 1 中完成
   - 步骤 2: 切换自动模式
   - 步骤 3: 启动设备

### 2. coin_cell_workstation.yaml

**位置：** 第 292-312 行

**修改内容：**

```yaml
auto-func_pack_device_init_auto_start_combined:
  goal_default:
    material_search_enable: false  # 新增默认值
  
  schema:
    description: 组合函数:设备初始化 + 物料搜寻确认 + 切换自动模式 + 启动。初始化过程中会自动检测物料搜寻确认弹窗，并根据参数自动点击"是"或"否"按钮
    
    goal:
      properties:
        material_search_enable:  # 新增参数配置
          default: false
          description: 是否启用物料搜寻功能。设备初始化后会弹出物料搜寻确认弹窗，此参数控制自动点击"是"(启用)或"否"(不启用)。默认为false(不启用物料搜寻)
          type: boolean
```

### 3. 测试脚本（已创建，用户已删除）

#### 3.1 test_material_search_dialog.py
- 从 CSV 动态加载 Modbus 地址
- 支持 4 种测试模式：
  - `query` - 查询所有状态
  - `dialog <0|1>` - 设置弹窗出现/消失
  - `yes` - 脉冲点击"是"按钮
  - `no` - 脉冲点击"否"按钮
- 兼容 pymodbus 3.x API

#### 3.2 更新其他测试脚本
- `test_coin_cell_reset.py` - 更新为 pymodbus 3.x API
- `test_unilab_interact.py` - 更新为 pymodbus 3.x API

## 使用方法

### 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `material_search_enable` | boolean | `false` | 是否启用物料搜寻功能 |

### 调用示例

#### 1. 不启用物料搜寻（默认）
```python
# 默认参数，点击"否"按钮
await device.func_pack_device_init_auto_start_combined()
```

或在 YAML workflow 中：
```yaml
# 使用默认值 false，不启用物料搜寻
- BatteryStation/auto-func_pack_device_init_auto_start_combined: {}
```

#### 2. 启用物料搜寻
```python
# 显式设置为 True，点击"是"按钮
await device.func_pack_device_init_auto_start_combined(
    material_search_enable=True
)
```

或在 YAML workflow 中：
```yaml
- BatteryStation/auto-func_pack_device_init_auto_start_combined:
    goal:
      material_search_enable: true  # 启用物料搜寻
```

## 执行日志示例

```
26-01-13 [21:32:44] [INFO] 开始组合操作：设备初始化 → 物料搜寻确认 → 自动模式 → 启动
26-01-13 [21:32:44] [INFO] 【步骤 0/4】前置条件检查...
26-01-13 [21:32:44] [INFO]   ✓ REG_UNILAB_INTERACT 检查通过
26-01-13 [21:32:44] [INFO]   ✓ COIL_GB_L_IGNORE_CMD 检查通过
26-01-13 [21:32:44] [INFO] 【步骤 1/4】设备初始化...
26-01-13 [21:32:44] [INFO] 切换手动模式...
26-01-13 [21:32:46] [INFO] 发送初始化命令...
26-01-13 [21:32:47] [INFO] 等待初始化完成（同时监测物料搜寻弹窗）...
26-01-13 [21:33:05] [INFO] ✓ 在初始化过程中检测到物料搜寻确认弹窗！
26-01-13 [21:33:05] [INFO] 用户选择: 不启用物料搜寻（点击否）
26-01-13 [21:33:05] [INFO]   → 按下按钮 '否'
26-01-13 [21:33:06] [INFO]   → 释放按钮 '否'
26-01-13 [21:33:07] [INFO] ✓ 成功处理物料搜寻确认弹窗（选择: 否）
26-01-13 [21:33:08] [INFO] ✓ 初始化状态完成
26-01-13 [21:33:12] [INFO] ✓ 设备初始化完成
26-01-13 [21:33:12] [INFO] 【步骤 1.5/4】物料搜寻确认已在初始化过程中完成
26-01-13 [21:33:12] [INFO] 【步骤 2/4】切换自动模式...
26-01-13 [21:33:15] [INFO] ✓ 切换自动模式完成
26-01-13 [21:33:15] [INFO] 【步骤 3/4】启动设备...
26-01-13 [21:33:18] [INFO] ✓ 启动设备完成
26-01-13 [21:33:18] [INFO] 组合操作完成：设备已成功初始化、确认物料搜寻、切换自动模式并启动
```

## 技术要点

### 1. 脉冲模式按钮操作
模拟真实按钮按压过程：
1. 写入 `True` (按下)
2. 保持 0.5 秒
3. 写入 `False` (释放)
4. 验证状态

### 2. 避免死锁
**问题：** PLC 在初始化过程中等待弹窗确认，而代码等待初始化完成  
**解决：** 在初始化等待循环中实时检测弹窗，一旦出现立即处理

### 3. 超时保护
- 弹窗检测超时：30 秒（在 `_handle_material_search_dialog` 中）
- 初始化超时：120 秒（在 `func_pack_device_init_auto_start_combined` 中）

### 4. PyModbus 3.x API 兼容
所有 Modbus 操作使用 keyword arguments：
```python
# 读取
client.read_coils(address=5176, count=1)

# 写入
client.write_coil(address=5184, value=True)
```

## 向后兼容性

### 保留的原有函数
- `func_pack_device_init()` - 单独的初始化函数，不包含弹窗处理
- 仍可在 YAML 中通过 `auto-func_pack_device_init` 调用
- 用于不需要自动处理弹窗的场景

### 新增的功能
- 在 `func_pack_device_init_auto_start_combined()` 中集成弹窗处理
- 通过参数控制，默认行为与之前兼容（点击"否"）

## 验证测试

### 测试场景

#### 场景 1：默认参数（不启用物料搜寻）
```bash
# 调用时不传参数
BatteryStation/auto-func_pack_device_init_auto_start_combined: {}
```
**预期结果：**
- ✅ 检测到弹窗
- ✅ 自动点击"否"按钮
- ✅ 初始化完成并启动成功

#### 场景 2：启用物料搜寻
```bash
# 设置 material_search_enable=true
BatteryStation/auto-func_pack_device_init_auto_start_combined:
  goal:
    material_search_enable: true
```
**预期结果：**
- ✅ 检测到弹窗
- ✅ 自动点击"是"按钮
- ✅ 初始化完成并启动成功

### 实际测试结果

**测试时间：** 2026-01-13 21:32:43  
**测试参数：** `material_search_enable: false`  
**测试结果：** ✅ 成功

**关键时间节点：**
- 21:33:05 - 检测到弹窗
- 21:33:05 - 按下"否"按钮
- 21:33:06 - 释放"否"按钮  
- 21:33:07 - 弹窗处理完成
- 21:33:08 - 初始化状态完成
- 21:33:18 - 整个流程完成

**总耗时：** 约 35 秒（包含初始化全过程）

## 注意事项

1. **CSV 配置依赖**
   - 确保 `coin_cell_assembly_b.csv` 包含 69-71 行的 coil 配置
   - 地址转换逻辑：`modbus_addr = (csv_addr // 10) * 8 + (csv_addr % 10)`

2. **默认行为**
   - 默认 `material_search_enable=false`，即不启用物料搜寻
   - 如需启用，必须显式设置为 `true`

3. **日志级别**
   - 弹窗检测过程中的 `waiting for init_cmd` 使用 DEBUG 级别
   - 关键操作（检测到弹窗、按钮操作）使用 INFO 级别

4. **原有函数保留**
   - `func_pack_device_init()` 仍然可用，但不包含弹窗处理
   - 如果单独调用此函数，仍需手动处理弹窗

## 文件清单

### 修改的文件
1. `d:\UniLabdev\Uni-Lab-OS\unilabos\devices\workstation\coin_cell_assembly\coin_cell_assembly.py`
   - 新增 `_handle_material_search_dialog()` 方法
   - 修改 `func_pack_device_init_auto_start_combined()` 函数

2. `d:\UniLabdev\Uni-Lab-OS\unilabos\registry\devices\coin_cell_workstation.yaml`
   - 更新 `auto-func_pack_device_init_auto_start_combined` 配置
   - 添加 `material_search_enable` 参数说明

3. `d:\UniLabdev\Uni-Lab-OS\unilabos\devices\workstation\coin_cell_assembly\coin_cell_assembly_b.csv`
   - 第 69-71 行添加三个 coil 配置

### 创建的测试文件（已删除）
1. `test_material_search_dialog.py` - 物料搜寻弹窗测试脚本
2. `test_coin_cell_reset.py` - 复位功能测试（更新为 pymodbus 3.x）
3. `test_unilab_interact.py` - Unilab 交互测试（更新为 pymodbus 3.x）

## 总结

本次更新成功实现了设备初始化过程中物料搜寻确认弹窗的自动化处理，主要优势：

✅ **全自动化** - 无需人工干预  
✅ **参数可配** - 灵活控制是否启用物料搜寻  
✅ **实时检测** - 在初始化等待循环中检测，避免死锁  
✅ **脉冲模式** - 模拟真实按钮操作  
✅ **向后兼容** - 保留原有函数，不影响现有流程  
✅ **完整日志** - 详细记录每一步操作  
✅ **超时保护** - 防止无限等待  

该功能已通过实际测试验证，可投入生产使用。

---

**文档版本：** 1.0  
**创建日期：** 2026-01-13  
**作者：** Antigravity AI Assistant  
**最后更新：** 2026-01-13 21:36
